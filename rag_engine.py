"""
rag_engine.py
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π RAG Engine –¥–ª—è –ì–ö –†–§ —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
–í–µ—Ä—Å–∏—è —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
"""

import re
import hashlib
from typing import List, Tuple, Optional, Dict, Any
from collections import OrderedDict, defaultdict
from threading import Lock

import tiktoken
import structlog

from langchain_core.documents import Document
from langchain_community.retrievers import BM25Retriever
from langchain_openai import ChatOpenAI
from sentence_transformers import CrossEncoder

from database import LegalVectorDB

log = structlog.get_logger()

# pip show langchain-core

# ================= CONFIG =================

SEMANTIC_TOP_K = 15
BM25_TOP_K = 15
RERANK_CANDIDATES = 25  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è reranking
RERANK_TOP_K = 5        # –§–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ reranking
RERANK_SCORE_THRESHOLD = 0.3  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π score –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞

LLM_MODEL = "gpt-4o-mini"
LLM_TEMPERATURE = 0.2
MAX_TOKENS = 1500

MAX_CACHE_SIZE = 1000
MAX_CACHE_ANSWER_LENGTH = 10000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–µ—à–∏—Ä—É–µ–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (10KB)

# –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
MAX_CONTEXT_TOKENS = 6000  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è GPT-4o-mini (8K context window)
SHORT_ARTICLE_THRESHOLD = 1500  # –î–æ —ç—Ç–æ–π –¥–ª–∏–Ω—ã - –≤—Å–µ–≥–¥–∞ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
LONG_ARTICLE_SUMMARY_LENGTH = 800  # –î–ª—è –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π

SYSTEM_PROMPT = """
–¢—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–º—É –∫–æ–¥–µ–∫—Å—É –†–§.

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ê–ù–¢–ò-–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø:
‚Ä¢ –£–ø–æ–º–∏–Ω–∞–π –¢–û–õ–¨–ö–û —Å—Ç–∞—Ç—å–∏ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∏–∂–µ
‚Ä¢ –ï—Å–ª–∏ —Å—Ç–∞—Ç—å–∏ –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ - –ù–ï —É–ø–æ–º–∏–Ω–∞–π –µ—ë –≤–æ–æ–±—â–µ
‚Ä¢ –õ—É—á—à–µ —Å–∫–∞–∑–∞—Ç—å "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ", —á–µ–º –≤—ã–¥—É–º–∞—Ç—å —Å—Ç–∞—Ç—å—é
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–π: –∫–∞–∂–¥–∞—è —É–ø–æ–º—è–Ω—É—Ç–∞—è —Å—Ç–∞—Ç—å—è –î–û–õ–ñ–ù–ê –±—ã—Ç—å –≤ —Ä–∞–∑–¥–µ–ª–µ "–ö–æ–Ω—Ç–µ–∫—Å—Ç" –Ω–∏–∂–µ

‚ö†Ô∏è –†–ï–ñ–ò–ú–´ –¶–ò–¢–ò–†–û–í–ê–ù–ò–Ø:

üéØ –†–ï–ñ–ò–ú 1 - –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª "—Å—Ç–∞—Ç—å—è X"):
‚Ä¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Ü–∏—Ç–∏—Ä—É–π –¥–æ—Å–ª–æ–≤–Ω–æ —Å –∫–∞–≤—ã—á–∫–∞–º–∏ ¬´...¬ª
‚Ä¢ –í–∫–ª—é—á–∞–π –í–°–ï –≤–∞–∂–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
‚Ä¢ –§–æ—Ä–º–∞—Ç: ¬´–¢–û–ß–ù–´–ô –¢–ï–ö–°–¢¬ª (—Å—Ç. X –ø. Y –ì–ö –†–§)

üìö –†–ï–ñ–ò–ú 2 - –û–±—â–∏–π –≤–æ–ø—Ä–æ—Å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ —Å–∏—Ç—É–∞—Ü–∏—é):
‚Ä¢ –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
‚Ä¢ –ù–æ –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫: (—Å–º. —Å—Ç. X –ø. Y –ì–ö –†–§)
‚Ä¢ –ï—Å–ª–∏ —Ü–∏—Ç–∏—Ä—É–µ—à—å - –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–≤—ã—á–∫–∏ ¬´...¬ª
‚Ä¢ –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω - —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏: "–°—Ç–∞—Ç—å—è —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è, –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /article_X"

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –ì–ö –†–§ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–∏–∂–µ
2. –ù–ï —É–ø–æ–º–∏–Ω–∞–π —Å—Ç–∞—Ç—å–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - —Å–∫–∞–∂–∏: "–í –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—å—è—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å."
4. –û–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º –ü–û–°–õ–ï —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

üéØ –î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏:
üìã –ö—Ä–∞—Ç–∫–∞—è —Å—É—Ç—å
üìå –¢–µ–∫—Å—Ç –∑–∞–∫–æ–Ω–∞:
¬´–î–û–°–õ–û–í–ù–ê–Ø –¶–ò–¢–ê–¢–ê¬ª (—Å—Ç. X –ø. Y –ì–ö –†–§)
üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:
[–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ]

üìö –î–ª—è –æ–±—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:
üìã –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:
–ü–æ –∑–∞–∫–æ–Ω—É [–∫—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ] (—Å—Ç. X –ø. Y –ì–ö –†–§).
–õ–∏–±–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ç–æ—á–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞):
¬´–¶–ò–¢–ê–¢–ê¬ª (—Å—Ç. X –ø. Y –ì–ö –†–§)
üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:
[–∫–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å]
‚öñÔ∏è –ü—Ä–∞–≤–æ–≤–∞—è –±–∞–∑–∞:
‚Ä¢ –°—Ç–∞—Ç—å—è X: [—Å—É—Ç—å]

üí° –í–ê–ñ–ù–û:
–ï—Å–ª–∏ —Å—Ç–∞—Ç—å—è –æ–±—Ä–µ–∑–∞–Ω–∞ –∏–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç - —Å–æ–æ–±—â–∏:
"‚ö†Ô∏è –ü–æ–∫–∞–∑–∞–Ω —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /article_X"

–ù–ï –î–ï–õ–ê–ô:
- –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –ù–µ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å—Ç–∞—Ç—å–∏, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–∏–∂–µ
- –ù–µ –∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π —Å—Ç–∞—Ç—å—é 8 –∏–ª–∏ –ª—é–±—É—é –¥—Ä—É–≥—É—é, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ!

–ü–ï–†–ï–î –û–¢–í–ï–¢–û–ú:
–ü—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. –£–ø–æ–º–∏–Ω–∞–π –¢–û–õ–¨–ö–û –∏—Ö!
"""


# ================= CACHE =================

class ResponseCache:
    """
    –£–º–Ω—ã–π –∫–µ—à —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –∑–∞–ø—Ä–æ—Å–æ–≤ (thread-safe)
    
    ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–∞–º—è—Ç–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è OOM
    """

    def __init__(
        self, 
        max_size: int = MAX_CACHE_SIZE,
        max_memory_mb: int = 50  # ‚úÖ –ù–û–í–û–ï: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–∞–º—è—Ç–∏
    ):
        self.cache = OrderedDict()
        self.max_size = max_size
        self.max_memory_mb = max_memory_mb
        self.current_memory_bytes = 0  # ‚úÖ –ù–û–í–û–ï: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
        self.hits = 0
        self.misses = 0
        self._lock = Lock()

    def _normalize_query(self, query: str) -> str:
        """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à"""
        query = query.lower().strip()
        query = re.sub(r'\s+', ' ', query)
        query = re.sub(r'[?!.]+$', '', query)
        query = query.replace('–≥–∫ —Ä—Ñ', '–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –∫–æ–¥–µ–∫—Å')
        query = query.replace('—Å—Ç.', '—Å—Ç–∞—Ç—å—è')
        query = query.replace('–ø.', '–ø—É–Ω–∫—Ç')
        return query

    def _get_key(self, query: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç —Ö–µ—à –∫–ª—é—á"""
        normalized = self._normalize_query(query)
        return hashlib.sha256(normalized.encode()).hexdigest()

    def get(self, query: str) -> Optional[str]:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞ (thread-safe)"""
        key = self._get_key(query)
        with self._lock:
            if key in self.cache:
                self.cache.move_to_end(key)
                self.hits += 1
                hit_rate = self.hits / (self.hits + self.misses) * 100
                log.info("cache_hit", hit_rate=f"{hit_rate:.1f}%")
                return self.cache[key]
            self.misses += 1
            return None

    def set(self, query: str, answer: str):
        """
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à (thread-safe)

        ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
        - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–µ—à–∏—Ä—É–µ–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –ø–∞–º—è—Ç–∏
        - Eviction –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –ø–∞–º—è—Ç–∏
        - –ó–∞—â–∏—Ç–∞ –æ—Ç OOM
        """
        key = self._get_key(query)
        
        # ================= MEMORY SAFETY =================
        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö (UTF-8)
        answer_size_bytes = len(answer.encode('utf-8'))
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        if answer_size_bytes > MAX_CACHE_ANSWER_LENGTH:
            log.warning(
                "cache_answer_truncated",
                answer_length=answer_size_bytes,
                max_length=MAX_CACHE_ANSWER_LENGTH
            )
            answer = answer[:MAX_CACHE_ANSWER_LENGTH] + "\n\n[... cached excerpt ...]"
            answer_size_bytes = len(answer.encode('utf-8'))
        
        with self._lock:
            # ‚úÖ –ù–û–í–û–ï: Eviction –ø–æ –ø–∞–º—è—Ç–∏
            # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º–µ—Å—Ç–æ –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏
            max_memory_bytes = self.max_memory_mb * 1024 * 1024
            
            while (
                len(self.cache) >= self.max_size or 
                self.current_memory_bytes + answer_size_bytes > max_memory_bytes
            ):
                if not self.cache:
                    break
                
                # –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π —ç–ª–µ–º–µ–Ω—Ç (LRU)
                old_key, old_value = self.cache.popitem(last=False)
                old_size = len(old_value.encode('utf-8'))
                self.current_memory_bytes -= old_size
                
                log.debug(
                    "cache_evicted",
                    key=old_key[:16],
                    freed_bytes=old_size,
                    current_memory_mb=f"{self.current_memory_bytes / (1024*1024):.2f}"
                )
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            self.cache[key] = answer
            self.current_memory_bytes += answer_size_bytes

    def stats(self) -> dict:
        """
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞ (thread-safe)
        
        ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–º—è—Ç–∏
        """
        with self._lock:
            total = self.hits + self.misses
            hit_rate = (self.hits / total * 100) if total > 0 else 0
            memory_mb = self.current_memory_bytes / (1024 * 1024)
            
            return {
                "size": len(self.cache),
                "max_size": self.max_size,
                "hits": self.hits,
                "misses": self.misses,
                "hit_rate": f"{hit_rate:.1f}%",
                "saved_requests": self.hits,
                "memory_mb": f"{memory_mb:.2f}",  # ‚úÖ –ù–û–í–û–ï
                "max_memory_mb": self.max_memory_mb,  # ‚úÖ –ù–û–í–û–ï
                "memory_usage_percent": f"{(memory_mb / self.max_memory_mb * 100):.1f}%"  # ‚úÖ –ù–û–í–û–ï
            }
    
    def invalidate_user_queries(self, user_id: int):
        """
        ‚úÖ –ù–û–í–û–ï: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (GDPR)
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ –∫–µ—à–∞
        """
        with self._lock:
            # –ò—â–µ–º –∫–ª—é—á–∏ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å user_id
            # (—ç—Ç–æ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞, —Ç.–∫. –≤ –∫–ª—é—á–µ —Ç–æ–ª—å–∫–æ hash –∑–∞–ø—Ä–æ—Å–∞)
            # –î–ª—è —Ç–æ—á–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å mapping user_id -> cache_keys
            
            # –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø: –û—á–∏—â–∞–µ–º –≤–µ—Å—å –∫–µ—à
            # –í production –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å {user_id: [cache_keys]} mapping
            log.warning(
                "cache_invalidation_full",
                reason="user_deletion",
                user_id=user_id,
                cleared_entries=len(self.cache)
            )
            
            old_size = len(self.cache)
            self.cache.clear()
            self.current_memory_bytes = 0
            
            log.info(f"‚úÖ Cache cleared for user {user_id}: {old_size} entries removed")


# ================= ENHANCED QUERY ANALYZER =================

class EnhancedQueryAnalyzer:
    """–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–ª–Ω—ã–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º"""

    @staticmethod
    def analyze(query: str) -> Dict[str, Any]:
        """
        –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        Returns: {
            "type": "specific_article" | "article_range" | "general",
            "article_num": "454",
            "article_range": ["454", "455", "456"],
            "point_num": "1",
            "subpoint": "–∞",
            "paragraph": "2",
            "part_gk": 2  # –ß–∞—Å—Ç—å –ì–ö –†–§
        }
        """
        query_lower = query.lower()
        result = {"type": "general"}

        # ========== –ß–ê–°–¢–¨ –ì–ö –†–§ ==========
        part_match = re.search(r'—á–∞—Å—Ç[—å–∏]\s+(\d)', query_lower)
        if part_match:
            result["part_gk"] = int(part_match.group(1))

        # ========== –î–ò–ê–ü–ê–ó–û–ù –°–¢–ê–¢–ï–ô ==========
        # "—Å—Ç–∞—Ç—å–∏ 454-456", "—Å—Ç. 100-105"
        range_patterns = [
            r'—Å—Ç–∞—Ç—å[–∏—è—é–µ]\s+(\d+)\s*[-‚Äì‚Äî]\s*(\d+)',
            r'—Å—Ç\.?\s*(\d+)\s*[-‚Äì‚Äî]\s*(\d+)'
        ]
        for pattern in range_patterns:
            match = re.search(pattern, query_lower)
            if match:
                start = int(match.group(1))
                end = int(match.group(2))
                result["type"] = "article_range"
                result["article_range"] = [str(i) for i in range(start, end + 1)]
                return result

        # ========== –°–¢–ê–¢–¨–Ø + –ü–£–ù–ö–¢ + –ü–û–î–ü–£–ù–ö–¢ ==========
        # "—Å—Ç–∞—Ç—å—è 454 –ø—É–Ω–∫—Ç 1 –ø–æ–¥–ø—É–Ω–∫—Ç –∞"
        full_pattern = r'—Å—Ç–∞—Ç—å[–∏—è—é–µ]\s+(\d+)\s+–ø—É–Ω–∫—Ç[–∞—É–µ—ã]?\s+(\d+)(?:\s+(?:–ø–æ–¥–ø—É–Ω–∫—Ç[–∞—É–µ—ã]?|–∞–±–∑–∞—Ü)\s+([–∞-—è]|\d+))?'
        match = re.search(full_pattern, query_lower)
        if match:
            result["type"] = "specific_article"
            result["article_num"] = match.group(1)
            result["point_num"] = match.group(2)
            if match.group(3):
                result["subpoint"] = match.group(3)
            return result

        # ========== –°–û–ö–†–ê–©–ï–ù–ù–ê–Ø –§–û–†–ú–ê ==========
        # "—Å—Ç. 454 –ø. 1 –ø–ø. –∞"
        short_pattern = r'—Å—Ç\.?\s*(\d+)\s+–ø\.?\s*(\d+)(?:\s+(?:–ø–ø\.?|–∞–±–∑\.?)\s*([–∞-—è]|\d+))?'
        match = re.search(short_pattern, query_lower)
        if match:
            result["type"] = "specific_article"
            result["article_num"] = match.group(1)
            result["point_num"] = match.group(2)
            if match.group(3):
                result["subpoint"] = match.group(3)
            return result

        # ========== –¢–û–õ–¨–ö–û –°–¢–ê–¢–¨–Ø ==========
        article_patterns = [
            r'—Å—Ç–∞—Ç—å[–∏—è—é–µ]\s+(\d+(?:\.\d+)?)',
            r'—Å—Ç\.?\s*(\d+(?:\.\d+)?)',
        ]
        for pattern in article_patterns:
            match = re.search(pattern, query_lower)
            if match:
                result["type"] = "specific_article"
                result["article_num"] = match.group(1)
                return result

        # ========== –¢–û–õ–¨–ö–û –ü–£–ù–ö–¢ (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ) ==========
        point_only = re.search(r'(?:^|\s)–ø—É–Ω–∫—Ç[–∞—É–µ—ã]?\s+(\d+)', query_lower)
        if point_only:
            result["point_hint"] = point_only.group(1)
            return result

        return result

# ================= QUERY CLARIFIER =================

class QueryClarifier:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω—ã –ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è"""

    @staticmethod
    def needs_clarification(question: str, docs: List[Document]) -> Optional[str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω—ã –ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è
        Returns: –¢–µ–∫—Å—Ç —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ None
        """
        question_lower = question.lower()

        # –°–ª–∏—à–∫–æ–º –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
        general_keywords = ["–¥–æ–≥–æ–≤–æ—Ä", "–ø—Ä–∞–≤–æ", "–º–æ–∂–Ω–æ –ª–∏", "–∫–∞–∫"]
        if len(question.split()) <= 3 and any(kw in question_lower for kw in general_keywords):
            return (
                "‚ùì –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n\n"
                "‚Ä¢ –û –∫–∞–∫–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –≤–∏–¥–µ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏–¥–µ—Ç —Ä–µ—á—å? (–∫—É–ø–ª—è-–ø—Ä–æ–¥–∞–∂–∞, –∞—Ä–µ–Ω–¥–∞, –ø–æ–¥—Ä—è–¥?)\n"
                "‚Ä¢ –ö–∞–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞?\n"
                "‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å?\n\n"
                "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç."
            )

        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–º
        if len(docs) > 0:
            parts = set(doc.metadata.get("part") for doc in docs[:5] if doc.metadata.get("part"))
            if len(parts) >= 3:  # –°—Ç–∞—Ç—å–∏ –∏–∑ 3+ —á–∞—Å—Ç–µ–π –ì–ö
                return (
                    "‚ùì –í–∞—à –≤–æ–ø—Ä–æ—Å –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª–æ–≤ –ì–ö –†–§.\n\n"
                    "–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n"
                    "‚Ä¢ –í –∫–∞–∫–æ–π –æ–±–ª–∞—Å—Ç–∏: –∫—É–ø–ª—è-–ø—Ä–æ–¥–∞–∂–∞, –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ, –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞?\n"
                    "‚Ä¢ –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–¥—Ä–æ–±–Ω–µ–µ\n\n"
                    "–ò–ª–∏ —è –º–æ–≥—É –¥–∞—Ç—å –æ–±—â–∏–π –æ—Ç–≤–µ—Ç –ø–æ –≤—Å–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–º –Ω–æ—Ä–º–∞–º?"
                )

        return None

# ================= RULE-BASED ROUTER =================

class RuleBasedRouter:
    """–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º (–±–µ–∑ LLM)"""

    def __init__(self, db: LegalVectorDB):
        self.db = db
        self.faq_cache = self._build_faq_cache()

    def _build_faq_cache(self) -> Dict[str, str]:
        """–°—Ç—Ä–æ–∏—Ç –∫—ç—à —Ç–æ—á–Ω—ã—Ö FAQ –æ—Ç–≤–µ—Ç–æ–≤ —Å –≥–æ—Ç–æ–≤—ã–º–∏ markdown –æ—Ç–≤–µ—Ç–∞–º–∏"""
        return {
            # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å -> –≥–æ—Ç–æ–≤—ã–π markdown –æ—Ç–≤–µ—Ç
            "—á—Ç–æ —Ç–∞–∫–æ–µ –∏—Å–∫–æ–≤–∞—è –¥–∞–≤–Ω–æ—Å—Ç—å": (
                "üìã **–ò—Å–∫–æ–≤–∞—è –¥–∞–≤–Ω–æ—Å—Ç—å** ‚Äî —ç—Ç–æ —Å—Ä–æ–∫ –¥–ª—è –∑–∞—â–∏—Ç—ã –ø—Ä–∞–≤–∞ –ø–æ –∏—Å–∫—É –ª–∏—Ü–∞, –ø—Ä–∞–≤–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–æ.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–û–±—â–∏–π —Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç—Ä–∏ –≥–æ–¥–∞¬ª (—Å—Ç. 196 –ì–ö –†–§).\n\n"
                "üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:\n"
                "–ï—Å–ª–∏ —É –≤–∞—Å –Ω–∞—Ä—É—à–µ–Ω–æ –ø—Ä–∞–≤–æ, —É –≤–∞—Å –µ—Å—Ç—å 3 –≥–æ–¥–∞ —á—Ç–æ–±—ã –ø–æ–¥–∞—Ç—å –∏—Å–∫ –≤ —Å—É–¥. "
                "–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å—Ä–æ–∫–∞ —Å—É–¥ –º–æ–∂–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å –≤ –∏—Å–∫–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –≤—ã –ø—Ä–∞–≤—ã.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏": (
                "üìã **–°—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏** —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **3 –≥–æ–¥–∞** —Å –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –ª–∏—Ü–æ —É–∑–Ω–∞–ª–æ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ —Å–≤–æ–µ–≥–æ –ø—Ä–∞–≤–∞.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–û–±—â–∏–π —Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç—Ä–∏ –≥–æ–¥–∞¬ª (—Å—Ç. 196 –ì–ö –†–§).\n\n"
                "üí° –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å:\n"
                "‚Ä¢ –°—Ä–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç–µ—á—å —Å –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –≤—ã —É–∑–Ω–∞–ª–∏ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏\n"
                "‚Ä¢ –ü–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –≤–∏–¥–∞–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏\n"
                "‚Ä¢ –°—Ä–æ–∫ –º–æ–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –¥–æ–ª–∂–Ω–∏–∫–∞ –∏–ª–∏ –ø–æ–¥–∞—á–µ–π –∏—Å–∫–∞\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—á—Ç–æ —Ç–∞–∫–æ–µ –¥–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏ –ø—Ä–æ–¥–∞–∂–∏": (
                "üìã **–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏** ‚Äî —ç—Ç–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ (–ø—Ä–æ–¥–∞–≤–µ—Ü) –æ–±—è–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å –≤–µ—â—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é), –∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —ç—Ç—É –≤–µ—â—å –∏ —É–ø–ª–∞—Ç–∏—Ç—å –∑–∞ –Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–µ–Ω–µ–∂–Ω—É—é —Å—É–º–º—É.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏ –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ (–ø—Ä–æ–¥–∞–≤–µ—Ü) –æ–±—è–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å –≤–µ—â—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é), –∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —ç—Ç—É –≤–µ—â—å –∏ —É–ø–ª–∞—Ç–∏—Ç—å –∑–∞ –Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–µ–Ω–µ–∂–Ω—É—é —Å—É–º–º—É (—Ü–µ–Ω—É)¬ª (—Å—Ç. 454 –ì–ö –†–§).\n\n"
                "üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:\n"
                "–í—ã –ø–ª–∞—Ç–∏—Ç–µ –¥–µ–Ω—å–≥–∏ ‚Äî –ø–æ–ª—É—á–∞–µ—Ç–µ –≤–µ—â—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥ –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤, –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –¥—Ä—É–≥–æ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–∞.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "–¥–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏ –ø—Ä–æ–¥–∞–∂–∏": (
                "üìã **–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏** ‚Äî —ç—Ç–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–¥–∞—á–µ –∏–º—É—â–µ—Å—Ç–≤–∞ –∑–∞ –¥–µ–Ω—å–≥–∏.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏ –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ (–ø—Ä–æ–¥–∞–≤–µ—Ü) –æ–±—è–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å –≤–µ—â—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é), –∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —ç—Ç—É –≤–µ—â—å –∏ —É–ø–ª–∞—Ç–∏—Ç—å –∑–∞ –Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–µ–Ω–µ–∂–Ω—É—é —Å—É–º–º—É (—Ü–µ–Ω—É)¬ª (—Å—Ç. 454 –ì–ö –†–§).\n\n"
                "üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:\n"
                "–í—Å–µ–≥–¥–∞ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ —É—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–∏—Å—å–º–µ–Ω–Ω–æ, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∫—Ä—É–ø–Ω—ã—Ö –ø–æ–∫—É–ø–∫–∞—Ö. –£–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ü–µ–Ω—É, –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏ —Å—Ä–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—á—Ç–æ —Ç–∞–∫–æ–µ –¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã": (
                "üìã **–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã** ‚Äî —ç—Ç–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ (–∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å) –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–º—É—â–µ—Å—Ç–≤–æ –∑–∞ –ø–ª–∞—Ç—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –∏ (–∏–ª–∏) –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä—É).\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É –∞—Ä–µ–Ω–¥—ã (–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–∞–π–º–∞) –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å (–Ω–∞–π–º–æ–¥–∞—Ç–µ–ª—å) –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä—É (–Ω–∞–Ω–∏–º–∞—Ç–µ–ª—é) –∏–º—É—â–µ—Å—Ç–≤–æ –∑–∞ –ø–ª–∞—Ç—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –∏ (–∏–ª–∏) –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ¬ª (—Å—Ç. 606 –ì–ö –†–§).\n\n"
                "üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:\n"
                "–í—ã –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–µ—â—å—é, –Ω–æ –æ–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—è. –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã: –∞—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã, –æ—Ñ–∏—Å–∞, –∞–≤—Ç–æ–º–æ–±–∏–ª—è.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "–¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã": (
                "üìã **–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã** ‚Äî —ç—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞ –ø–ª–∞—Ç—É.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É –∞—Ä–µ–Ω–¥—ã (–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–∞–π–º–∞) –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å (–Ω–∞–π–º–æ–¥–∞—Ç–µ–ª—å) –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä—É (–Ω–∞–Ω–∏–º–∞—Ç–µ–ª—é) –∏–º—É—â–µ—Å—Ç–≤–æ –∑–∞ –ø–ª–∞—Ç—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –∏ (–∏–ª–∏) –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ¬ª (—Å—Ç. 606 –ì–ö –†–§).\n\n"
                "üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:\n"
                "–í –¥–æ–≥–æ–≤–æ—Ä–µ –∞—Ä–µ–Ω–¥—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ: –ø—Ä–µ–¥–º–µ—Ç –∞—Ä–µ–Ω–¥—ã, —Å—Ä–æ–∫, —Ä–∞–∑–º–µ—Ä –∞—Ä–µ–Ω–¥–Ω–æ–π –ø–ª–∞—Ç—ã –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—á—Ç–æ —Ç–∞–∫–æ–µ –¥–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞": (
                "üìã **–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞** ‚Äî —ç—Ç–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ (–ø–æ–¥—Ä—è–¥—á–∏–∫) –æ–±—è–∑—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ –∑–∞–¥–∞–Ω–∏—é –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã (–∑–∞–∫–∞–∑—á–∏–∫–∞) –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ —Å–¥–∞—Ç—å –µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–∫–∞–∑—á–∏–∫—É, –∞ –∑–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –µ–≥–æ.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É –ø–æ–¥—Ä—è–¥–∞ –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ (–ø–æ–¥—Ä—è–¥—á–∏–∫) –æ–±—è–∑—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ –∑–∞–¥–∞–Ω–∏—é –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã (–∑–∞–∫–∞–∑—á–∏–∫–∞) –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ —Å–¥–∞—Ç—å –µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–∫–∞–∑—á–∏–∫—É, –∞ –∑–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –µ–≥–æ¬ª (—Å—Ç. 702 –ì–ö –†–§).\n\n"
                "üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:\n"
                "–í—ã –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞ –≤—Ä–µ–º—è. –ü—Ä–∏–º–µ—Ä—ã: —Ä–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –ø–æ—à–∏–≤ –æ–¥–µ–∂–¥—ã.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "–¥–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞": (
                "üìã **–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞** ‚Äî —ç—Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∑–∞ –ø–ª–∞—Ç—É —Å –ø–µ—Ä–µ–¥–∞—á–µ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–∫–∞–∑—á–∏–∫—É.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É –ø–æ–¥—Ä—è–¥–∞ –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ (–ø–æ–¥—Ä—è–¥—á–∏–∫) –æ–±—è–∑—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ –∑–∞–¥–∞–Ω–∏—é –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã (–∑–∞–∫–∞–∑—á–∏–∫–∞) –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ —Å–¥–∞—Ç—å –µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–∫–∞–∑—á–∏–∫—É, –∞ –∑–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –µ–≥–æ¬ª (—Å—Ç. 702 –ì–ö –†–§).\n\n"
                "üí° –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å:\n"
                "‚Ä¢ –ü–æ–¥—Ä—è–¥—á–∏–∫ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã\n"
                "‚Ä¢ –ó–∞–∫–∞–∑—á–∏–∫ –º–æ–∂–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è\n"
                "‚Ä¢ –†–∏—Å–∫ —Å–ª—É—á–∞–π–Ω–æ–π –≥–∏–±–µ–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –∑–∞–∫–∞–∑—á–∏–∫—É –ø—Ä–∏ –ø—Ä–∏–µ–º–∫–µ\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—á—Ç–æ —Ç–∞–∫–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": (
                "üìã **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ** ‚Äî —ç—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –∏–º—É—â–µ—Å—Ç–≤–∞ —É–º–µ—Ä—à–µ–≥–æ –∫ –¥—Ä—É–≥–∏–º –ª–∏—Ü–∞–º –≤ –ø–æ—Ä—è–¥–∫–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–æ–ø—Ä–µ–µ–º—Å—Ç–≤–∞.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü—Ä–∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ –∏–º—É—â–µ—Å—Ç–≤–æ —É–º–µ—Ä—à–µ–≥–æ (–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ, –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ) –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –¥—Ä—É–≥–∏–º –ª–∏—Ü–∞–º –≤ –ø–æ—Ä—è–¥–∫–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–æ–ø—Ä–µ–µ–º—Å—Ç–≤–∞¬ª (—Å—Ç. 1110 –ì–ö –†–§).\n\n"
                "üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:\n"
                "–ü–æ—Å–ª–µ —Å–º–µ—Ä—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ –µ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞–º –ø–æ –∑–∞–∫–æ–Ω—É –∏–ª–∏ –ø–æ –∑–∞–≤–µ—â–∞–Ω–∏—é. –ù–∞—Å–ª–µ–¥–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∞, –Ω–æ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (–¥–æ–ª–≥–∏).\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": (
                "üìã **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ** ‚Äî —ç—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –∏–º—É—â–µ—Å—Ç–≤–∞ —É–º–µ—Ä—à–µ–≥–æ –∫ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞–º.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–ü—Ä–∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ –∏–º—É—â–µ—Å—Ç–≤–æ —É–º–µ—Ä—à–µ–≥–æ (–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ, –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ) –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –¥—Ä—É–≥–∏–º –ª–∏—Ü–∞–º –≤ –ø–æ—Ä—è–¥–∫–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–æ–ø—Ä–µ–µ–º—Å—Ç–≤–∞¬ª (—Å—Ç. 1110 –ì–ö –†–§).\n\n"
                "üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:\n"
                "‚Ä¢ –ù–∞—Å–ª–µ–¥—Å—Ç–≤–æ –º–æ–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å –ø–æ –∑–∞–≤–µ—â–∞–Ω–∏—é –∏–ª–∏ –ø–æ –∑–∞–∫–æ–Ω—É\n"
                "‚Ä¢ –ù–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–∞ –¥–∞–µ—Ç—Å—è 6 –º–µ—Å—è—Ü–µ–≤\n"
                "‚Ä¢ –í–º–µ—Å—Ç–µ —Å –∏–º—É—â–µ—Å—Ç–≤–æ–º –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –∏ –¥–æ–ª–≥–∏ —É–º–µ—Ä—à–µ–≥–æ\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—á—Ç–æ —Ç–∞–∫–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ": (
                "üìã **–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ** ‚Äî —ç—Ç–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∏–º–µ–µ—Ç –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–º –≤–µ–¥–µ–Ω–∏–∏ –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±–æ—Å–æ–±–ª–µ–Ω–Ω–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ —Å–≤–æ–∏–º –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º —ç—Ç–∏–º –∏–º—É—â–µ—Å—Ç–≤–æ–º.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –ª–∏—Ü–æ–º –ø—Ä–∏–∑–Ω–∞–µ—Ç—Å—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∏–º–µ–µ—Ç –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–º –≤–µ–¥–µ–Ω–∏–∏ –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±–æ—Å–æ–±–ª–µ–Ω–Ω–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ —Å–≤–æ–∏–º –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º —ç—Ç–∏–º –∏–º—É—â–µ—Å—Ç–≤–æ–º, –º–æ–∂–µ—Ç –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏ –ø—Ä–∏–æ–±—Ä–µ—Ç–∞—Ç—å –∏ –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –∏ –Ω–µ—Å—Ç–∏ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –±—ã—Ç—å –∏—Å—Ç—Ü–æ–º –∏ –æ—Ç–≤–µ—Ç—á–∏–∫–æ–º –≤ —Å—É–¥–µ¬ª (—Å—Ç. 48 –ì–ö –†–§).\n\n"
                "üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:\n"
                "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ ‚Äî —ç—Ç–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—É–±—ä–µ–∫—Ç –ø—Ä–∞–≤–∞ –º–æ–∂–µ—Ç –≤–ª–∞–¥–µ—Ç—å –∏–º—É—â–µ—Å—Ç–≤–æ–º, –∑–∞–∫–ª—é—á–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ã –∏ –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º. –ü—Ä–∏–º–µ—Ä—ã: –û–û–û, –ê–û, —Ñ–æ–Ω–¥—ã.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ": (
                "üìã **–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ** ‚Äî —ç—Ç–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, —è–≤–ª—è—é—â–∞—è—Å—è —Å—É–±—ä–µ–∫—Ç–æ–º –ø—Ä–∞–≤–∞.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –ª–∏—Ü–æ–º –ø—Ä–∏–∑–Ω–∞–µ—Ç—Å—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∏–º–µ–µ—Ç –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–º –≤–µ–¥–µ–Ω–∏–∏ –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±–æ—Å–æ–±–ª–µ–Ω–Ω–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ —Å–≤–æ–∏–º –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º —ç—Ç–∏–º –∏–º—É—â–µ—Å—Ç–≤–æ–º¬ª (—Å—Ç. 48 –ì–ö –†–§).\n\n"
                "üí° –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å:\n"
                "‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –ï–ì–†–Æ–õ\n"
                "‚Ä¢ –û–Ω–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç —á–µ—Ä–µ–∑ —Å–≤–æ–∏ –æ—Ä–≥–∞–Ω—ã (–¥–∏—Ä–µ–∫—Ç–æ—Ä, —Å–æ–≤–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤)\n"
                "‚Ä¢ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ–º —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ": (
                "üìã **–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ** ‚Äî —ç—Ç–æ —á–µ–ª–æ–≤–µ–∫ –∫–∞–∫ —Å—É–±—ä–µ–∫—Ç –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–∞–≤–∞, –æ–±–ª–∞–¥–∞—é—â–∏–π –ø—Ä–∞–≤–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –∏ –¥–µ–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–º–µ—Ç—å –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –∏ –Ω–µ—Å—Ç–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –ø—Ä–∞–≤–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å) –ø—Ä–∏–∑–Ω–∞–µ—Ç—Å—è –∑–∞ –≤—Å–µ–º–∏ –≥—Ä–∞–∂–¥–∞–Ω–∞–º–∏¬ª (—Å—Ç. 17 –ì–ö –†–§).\n\n"
                "üí¨ –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:\n"
                "–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ ‚Äî —ç—Ç–æ –ª—é–±–æ–π —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏. –ü—Ä–∞–≤–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Å —Ä–æ–∂–¥–µ–Ω–∏—è, –∞ –ø–æ–ª–Ω–∞—è –¥–µ–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ‚Äî —Å 18 –ª–µ—Ç.\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
            "—Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ": (
                "üìã **–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ** ‚Äî —ç—Ç–æ —á–µ–ª–æ–≤–µ–∫ –∫–∞–∫ —Å—É–±—ä–µ–∫—Ç –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–∞–≤–∞.\n\n"
                "üìå –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞–∫–æ–Ω:\n"
                "¬´–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–º–µ—Ç—å –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –∏ –Ω–µ—Å—Ç–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –ø—Ä–∞–≤–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å) –ø—Ä–∏–∑–Ω–∞–µ—Ç—Å—è –∑–∞ –≤—Å–µ–º–∏ –≥—Ä–∞–∂–¥–∞–Ω–∞–º–∏¬ª (—Å—Ç. 17 –ì–ö –†–§).\n\n"
                "üí° –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å:\n"
                "‚Ä¢ –ü—Ä–∞–≤–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ‚Äî —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ (—Å —Ä–æ–∂–¥–µ–Ω–∏—è)\n"
                "‚Ä¢ –î–µ–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ‚Äî —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –ø—Ä–∞–≤–∞ (—Å 18 –ª–µ—Ç)\n"
                "‚Ä¢ –ù–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏–µ –∏–º–µ—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—É—é –¥–µ–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å\n\n"
                "‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            ),
        }

    def route(self, query: str, query_analysis: Dict) -> Tuple[str, Optional[str]]:
        """
        –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞

        Returns: ("route_type", answer_or_none)

        Routes:
        - "exact_faq": —Ç–æ—á–Ω—ã–π FAQ –æ—Ç–≤–µ—Ç (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç)
        - "direct_article": –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—å–∏ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None, –∏—Å–ø–æ–ª—å–∑—É–π –ë–î)
        - "article_range": –¥–∏–∞–ø–∞–∑–æ–Ω —Å—Ç–∞—Ç–µ–π (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None)
        - "hybrid_rag": –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ + LLM (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None)
        """
        # ========== –ü–†–ò–û–†–ò–¢–ï–¢ 1: –¢–æ—á–Ω—ã–µ FAQ ==========
        normalized = self._normalize_query(query)
        if normalized in self.faq_cache:
            article_ref = self.faq_cache[normalized]
            # –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞—Ç—å—é
            return ("exact_faq", article_ref)

        # ========== –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—å–∏ ==========
        if query_analysis["type"] == "specific_article":
            return ("direct_article", None)

        # ========== –ü–†–ò–û–†–ò–¢–ï–¢ 3: –î–∏–∞–ø–∞–∑–æ–Ω —Å—Ç–∞—Ç–µ–π ==========
        if query_analysis["type"] == "article_range":
            return ("article_range", None)

        # ========== –ü–†–ò–û–†–ò–¢–ï–¢ 4: –ì–∏–±—Ä–∏–¥–Ω—ã–π RAG ==========
        return ("hybrid_rag", None)

    def _normalize_query(self, query: str) -> str:
        """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"""
        q = query.lower().strip()
        q = re.sub(r'[?!.,;]', '', q)
        q = re.sub(r'\s+', ' ', q)
        return q


# ================= ANSWER VALIDATOR =================

class AnswerValidator:
    """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã LLM –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""

    def __init__(self, db: LegalVectorDB):
        self.db = db

    def validate(self, question: str, answer: str, context_docs: List[Document]) -> Tuple[bool, Optional[str]]:
        """
        –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
        Returns: (is_valid, error_message)
        """
        # ========== 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã ==========
        if len(answer) < 50:
            return False, "–û—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π"

        # ========== 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–°–ú–Ø–ì–ß–ï–ù–û) ==========
        # –î–ª—è –æ–±—â–∏—Ö/—Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Å—Ç–∞—Ç—å–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
        question_lower = question.lower()
        system_keywords = ["–∑–∞–ø–∏—Å", "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü", "–ø–æ–º–æ—â—å", "–∫–æ–Ω—Ç–∞–∫—Ç", "—Å–≤—è–∑"]
        is_system_question = any(kw in question_lower for kw in system_keywords)
        
        has_article_refs = bool(re.search(r'—Å—Ç(?:–∞—Ç—å—è|\.)\s*\d+', answer, re.IGNORECASE))
        
        if not has_article_refs and not is_system_question:
            # –¢–æ–ª—å–∫–æ –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Ç—Ä–µ–±—É–µ–º —Å—Å—ã–ª–∫–∏
            return False, "–û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—Ç–∞—Ç—å–∏"

        # ========== 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π —Å—Ç–∞—Ç–µ–π ==========
        mentioned_articles = re.findall(r'—Å—Ç–∞—Ç—å[–∏—è—é–µ]\s+(\d+)|—Å—Ç\.?\s*(\d+)', answer, re.IGNORECASE)
        mentioned_articles = set(a[0] or a[1] for a in mentioned_articles)

        context_articles = set()
        for doc in context_docs:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç–∞—Ç—å–∏ –∏–∑ reference –∏–ª–∏ metadata
            article_num = doc.metadata.get("article_num")
            if article_num:
                context_articles.add(str(article_num))
            else:
                # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ reference
                ref = doc.metadata.get("reference", "")
                match = re.search(r'—Å—Ç(?:–∞—Ç—å—è|\.)\s*(\d+)', ref, re.IGNORECASE)
                if match:
                    context_articles.add(match.group(1))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Å—Ç–∞—Ç—å–∏ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        hallucinated = mentioned_articles - context_articles
        
        if hallucinated:
            # –°–ú–Ø–ì–ß–ï–ù–û: —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ 2 –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏
            if len(hallucinated) <= 2 and len(mentioned_articles - hallucinated) > 0:
                log.warning("minor_hallucination_allowed", articles=list(hallucinated))
                # –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–≤–µ—Ç —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
            else:
                # –°–µ—Ä—å–µ–∑–Ω–∞—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è - –æ—Ç–∫–ª–æ–Ω—è–µ–º
                log.error("hallucination_detected", articles=list(hallucinated))
                return False, f"–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç–∞—Ç—å–∏ –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {', '.join(sorted(hallucinated))}"

        # ========== 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ ==========
        forbidden = [
            "—è –Ω–µ –º–æ–≥—É", "—É –º–µ–Ω—è –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", "–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É",
            "—è –Ω–µ —É–≤–µ—Ä–µ–Ω", "–≤–æ–∑–º–æ–∂–Ω–æ", "–≤–µ—Ä–æ—è—Ç–Ω–æ"
        ]
        answer_lower = answer.lower()
        for phrase in forbidden:
            if phrase in answer_lower:
                log.warning("answer_forbidden_phrase", phrase=phrase)
                # –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º

        # ========== 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ/–±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã ==========
        if answer.count('...') > 3:
            return False, "–û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–Ω–æ–≥–æ—Ç–æ—á–∏–π"

        # ========== 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ü–∏—Ç–∞—Ç (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û) ==========
        has_quotes = '¬´' in answer or '"' in answer
        if len(context_docs) > 0 and not has_quotes and not is_system_question:
            log.warning("answer_no_quotes")
            # –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º - —Ü–∏—Ç–∞—Ç—ã –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω—ã

        return True, None


# ================= MAIN ENGINE =================

class LegalRAG:
    """–û—Å–Ω–æ–≤–Ω–æ–π RAG –¥–≤–∏–∂–æ–∫ –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π"""

    def __init__(self):
        log.info("rag_engine_initializing")

        # –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î
        self.db = LegalVectorDB()
        self.db.load()

        # LLM
        self.llm = ChatOpenAI(
            model=LLM_MODEL,
            temperature=LLM_TEMPERATURE,
            max_tokens=MAX_TOKENS,
            request_timeout=30,
        )

        # Reranker –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é (lazy load)
        self._reranker = None

        # –ö–µ—à
        self.cache = ResponseCache()
        
        # Query analyzer (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ EnhancedQueryAnalyzer)
        self.enhanced_analyzer = EnhancedQueryAnalyzer()

        # Rule-based router
        self.router = RuleBasedRouter(self.db)

        # ================= TOKEN COUNTING =================
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º tiktoken encoder –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤
        # –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞, –≥–¥–µ –Ω–∞ 1 —Ç–æ–∫–µ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –±–æ–ª—å—à–µ —Å–∏–º–≤–æ–ª–æ–≤
        try:
            self.tokenizer = tiktoken.encoding_for_model(LLM_MODEL)
            log.info("tokenizer_initialized", model=LLM_MODEL)
        except Exception as e:
            log.warning("tokenizer_init_failed", model=LLM_MODEL, error=str(e)[:100], fallback="cl100k_base")
            self.tokenizer = tiktoken.get_encoding("cl100k_base")

        # –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
        self._init_hybrid_search()

        log.info("rag_engine_ready")

    def _get_device(self) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π"""
        try:
            import torch
            if torch.cuda.is_available():
                return "cuda"
        except ImportError:
            pass
        return "cpu"
    
    def _get_reranker(self):
        """Lazy initialization reranker –º–æ–¥–µ–ª–∏"""
        if self._reranker is None:
            log.info("reranker_loading")
            device = self._get_device()
            log.info("reranker_device", device=device)
            self._reranker = CrossEncoder(
                "cross-encoder/mmarco-mMiniLMv2-L12-H384-v1",
                device=device
            )
            log.info("reranker_loaded")
        return self._reranker

    # ================= HYBRID SEARCH =================

    def _init_hybrid_search(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å MMR"""
        log.info("hybrid_search_setup")

        all_docs = self.db.get_all_documents()
        log.info("documents_loaded", count=len(all_docs))

        # Semantic retriever —Å MMR –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        self.semantic_retriever = self.db.vector_db.as_retriever(
            search_type="mmr",
            search_kwargs={
                "k": SEMANTIC_TOP_K,
                "fetch_k": 20,  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è MMR
                "lambda_mult": 0.5  # –ë–∞–ª–∞–Ω—Å: 0.5 = 50% —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å, 50% —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
            }
        )

        # BM25 retriever
        self.bm25_retriever = BM25Retriever.from_documents(all_docs)
        self.bm25_retriever.k = BM25_TOP_K

        log.info("hybrid_search_ready")

    def _hybrid_retrieve(self, question: str) -> List[Document]:
        """
        –ò–°–ü–†–ê–í–õ–ï–ù–û: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ —Å –Ω–∞–¥–µ–∂–Ω–æ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç doc_id –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        """
        # Semantic search
        semantic_docs = self.semantic_retriever.invoke(question)
        
        # BM25 search
        bm25_docs = self.bm25_retriever.invoke(question)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ–º –ø–æ doc_id
        seen_doc_ids = set()
        merged = []
        
        # –°–Ω–∞—á–∞–ª–∞ semantic (–±–æ–ª—å—à–∏–π –≤–µ—Å)
        for doc in semantic_docs:
            doc_id = doc.metadata.get("doc_id")
            if doc_id and doc_id not in seen_doc_ids:
                seen_doc_ids.add(doc_id)
                merged.append(doc)
            elif not doc_id:
                # Fallback –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ doc_id (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ production)
                log.warning("document_without_doc_id", reference=doc.metadata.get('reference', 'unknown'))
                merged.append(doc)
        
        # –ü–æ—Ç–æ–º BM25
        for doc in bm25_docs:
            doc_id = doc.metadata.get("doc_id")
            if doc_id and doc_id not in seen_doc_ids:
                seen_doc_ids.add(doc_id)
                merged.append(doc)
            elif not doc_id:
                # Fallback –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ doc_id
                log.warning("document_without_doc_id", reference=doc.metadata.get('reference', 'unknown'))
                merged.append(doc)

        log.info(
            f"Hybrid search: semantic={len(semantic_docs)}, bm25={len(bm25_docs)}, "
            f"merged={len(merged)}, unique_doc_ids={len(seen_doc_ids)}"
        )
        return merged

    def _is_safe(self, text: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç prompt injection)
        """
        dangerous = [
            # ========== Prompt injection - –∞–Ω–≥–ª–∏–π—Å–∫–∏–π ==========
            r"ignore\s+(?:all\s+)?(?:previous|the|your)?\s*(?:instructions|commands|rules|prompts|constraints)",
            r"forget\s+(?:all\s+)?(?:previous|the|your)?\s*(?:instructions|commands|rules|prompts|constraints)",
            r"disregard\s+(?:all\s+)?(?:previous|the|your)?\s*(?:instructions|commands|rules|prompts|constraints)",
            r"override\s+(?:all\s+)?(?:previous|the|your)?\s*(?:instructions|commands|rules|prompts|constraints)",
            r"bypass\s+(?:all\s+)?(?:previous|the|your)?\s*(?:instructions|commands|rules|prompts|constraints)",
            r"dismiss\s+(?:all\s+)?(?:previous|the|your)?\s*(?:instructions|commands|rules|prompts|constraints)",
            r"neglect\s+(?:all\s+)?(?:previous|the|your)?\s*(?:instructions|commands|rules|prompts|constraints)",

            # ========== Prompt injection - —Ä—É—Å—Å–∫–∏–π ==========
            r"–ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π\s+(?:–≤—Å–µ\s+)?(?:–ø—Ä–µ–¥—ã–¥—É—â–∏–µ|—Å–≤–æ–∏|—Ç–≤–æ–∏|–≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ)?\s*(?:–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏|–∫–æ–º–∞–Ω–¥—ã|–ø—Ä–∞–≤–∏–ª–∞|–ø—Ä–æ–º–ø—Ç—ã|–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)",
            r"–∑–∞–±—É–¥—å\s+(?:–≤—Å–µ\s+)?(?:–ø—Ä–µ–¥—ã–¥—É—â–∏–µ|—Å–≤–æ–∏|—Ç–≤–æ–∏|–≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ)?\s*(?:–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏|–∫–æ–º–∞–Ω–¥—ã|–ø—Ä–∞–≤–∏–ª–∞|–ø—Ä–æ–º–ø—Ç—ã|–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)",
            r"–Ω–µ\s+–æ–±—Ä–∞—â–∞–π\s+–≤–Ω–∏–º–∞–Ω–∏–µ\s+–Ω–∞\s+(?:–≤—Å–µ\s+)?(?:–ø—Ä–µ–¥—ã–¥—É—â–∏–µ|—Å–≤–æ–∏|—Ç–≤–æ–∏|–≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ)?\s*(?:–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏|–∫–æ–º–∞–Ω–¥—ã|–ø—Ä–∞–≤–∏–ª–∞|–ø—Ä–æ–º–ø—Ç—ã|–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)",
            r"–æ—Ç–º–µ–Ω–∏\s+(?:–≤—Å–µ\s+)?(?:–ø—Ä–µ–¥—ã–¥—É—â–∏–µ|—Å–≤–æ–∏|—Ç–≤–æ–∏|–≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ)?\s*(?:–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏|–∫–æ–º–∞–Ω–¥—ã|–ø—Ä–∞–≤–∏–ª–∞|–ø—Ä–æ–º–ø—Ç—ã|–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)",
            r"–æ—Ç–∫–ª–æ–Ω–∏—Ç—å\s+(?:–≤—Å–µ\s+)?(?:–ø—Ä–µ–¥—ã–¥—É—â–∏–µ|—Å–≤–æ–∏|—Ç–≤–æ–∏|–≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ)?\s*(?:–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏|–∫–æ–º–∞–Ω–¥—ã|–ø—Ä–∞–≤–∏–ª–∞|–ø—Ä–æ–º–ø—Ç—ã|–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)",
            r"–∏–≥–Ω–æ—Ä–∏—Ä—É–π\s+(?:–≤—Å–µ\s+)?(?:–ø—Ä–µ–¥—ã–¥—É—â–∏–µ|—Å–≤–æ–∏|—Ç–≤–æ–∏|–≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ)?\s*(?:–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏|–∫–æ–º–∞–Ω–¥—ã|–ø—Ä–∞–≤–∏–ª–∞|–ø—Ä–æ–º–ø—Ç—ã|–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)",

            # ========== System prompt attacks ==========
            r"system\s+prompt",
            r"—Å–∏—Å—Ç–µ–º–Ω(?:—ã–π|–∞—è|–æ–µ|—ã–µ)\s+–ø—Ä–æ–º–ø—Ç(?:—ã|–æ–≤|–∞–º)?",
            r"developer\s+instructions",
            r"–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏\s+—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞",
            r"initial\s+instructions",
            r"–Ω–∞—á–∞–ª—å–Ω—ã–µ\s+–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏",

            # ========== Role playing / persona attacks ==========
            r"you\s+are\s+now",
            r"—Ç—ã\s+—Å–µ–π—á–∞—Å",
            r"act\s+as",
            r"—Å—ã–≥—Ä–∞–π\s+—Ä–æ–ª—å",
            r"pretend\s+to\s+be",
            r"–ø—Ä–∏—Ç–≤–æ—Ä–∏—Å—å\s+—á—Ç–æ\s+—Ç—ã",
            r"assume\s+the\s+role",
            r"–ø—Ä–∏–Ω–∏–º–∞–π\s+—Ä–æ–ª—å",

            # ========== Jailbreak patterns ==========
            r"dan\s+mode",
            r"jailbreak",
            r"bypass\s+filters?",
            r"–æ–±—Ö–æ–¥\s+—Ñ–∏–ª—å—Ç—Ä(?:–æ–≤|–∞)?",
            r"unrestricted\s+mode",
            r"–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π",

            # ========== Code execution / SQL injection ==========
            r"';\s*drop\s+table",
            r"';\s*delete\s+from",
            r"';\s*exec\s*\(",
            r"<script>",

            # ========== Unicode evasion ==========
            r"[\u2000-\u200F\u202A-\u202E\u2060-\u206F\uFEFF]",  # Zero-width, bidirectional, BOM
        ]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
        for pattern in dangerous:
            match = re.search(pattern, text, re.IGNORECASE | re.UNICODE)
            if match:
                log.warning(f"Unsafe query detected (pattern: {pattern}): {match.group(0)}")
                return False

        return True


    def _sort_by_point_number(self, docs: List[Document]) -> List[Document]:
        """
        –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –Ω–æ–º–µ—Ä—É –ø—É–Ω–∫—Ç–∞
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç None, "full" –∏ –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç article_order_index –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞.
        """
        def point_sort_key(doc):
            # –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º article_order_index –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
            order_index = doc.metadata.get("article_order_index", 999999)

            value = doc.metadata.get("point_num")
            
            # –ï—Å–ª–∏ —ç—Ç–æ "full", None –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ - –≤ –∫–æ–Ω–µ—Ü
            if not value or value == "full":
                return (order_index, 9999)

            # –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if str(value).isdigit():
                return (order_index, int(value))

            # –ò–Ω–∞—á–µ –≤ –∫–æ–Ω–µ—Ü
            return (order_index, 9999)

        return sorted(docs, key=point_sort_key)

    # ================= RETRIEVAL =================

    def retrieve_documents(self, question: str, query_type: Dict) -> Tuple[List[Document], str]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞"""
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç –¥–∏–∞–ø–∞–∑–æ–Ω —Å—Ç–∞—Ç–µ–π
        if query_type["type"] == "article_range":
            article_range = query_type["article_range"]
            log.info(f"Retrieving article range: {article_range}")

            all_docs = []
            for article_num in article_range:
                docs = self.db.get_article_by_number(article_num)
                all_docs.extend(docs)

            if not all_docs:
                return [], ""
            
            # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            all_docs = self._sort_by_point_number(all_docs)

            context = self._build_context(all_docs, query_type, show_full=True)
            return all_docs, context

        # –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é
        if query_type["type"] == "specific_article":
            article_num = query_type["article_num"]
            point_num = query_type.get("point_num")
            subpoint = query_type.get("subpoint")
            part_gk = query_type.get("part_gk")

            log.info(f"Retrieving specific article {article_num}, point {point_num}, subpoint {subpoint}, part {part_gk}")

            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—å—é –∏–∑ –ë–î
            docs = self.db.get_article_by_number(article_num)

            if not docs:
                return [], ""

            # –§–∏–ª—å—Ç—Ä –ø–æ —á–∞—Å—Ç–∏ –ì–ö –†–§
            if part_gk:
                docs = [d for d in docs if d.metadata.get("part") == part_gk]

            # –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—É–Ω–∫—Ç
            if point_num:
                docs = [d for d in docs if d.metadata.get("point_num") == point_num]

            # –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø–æ–¥–ø—É–Ω–∫—Ç (—Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É)
            if subpoint:
                docs = [d for d in docs if subpoint.lower() in d.page_content.lower()]

            # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            docs = self._sort_by_point_number(docs)

            context = self._build_context(docs, query_type, show_full=True)
            return docs, context

        # –û–±—â–∏–π –≤–æ–ø—Ä–æ—Å - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
        log.info(f"Retrieving for general query: {question[:100]}...")
        
        docs = self._hybrid_retrieve(question)

        if not docs:
            log.warning("No documents found!")
            return [], ""

        # ========== 5. Reranking —Å batch_size –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
        log.info(f"Reranking top {min(len(docs), RERANK_CANDIDATES)} candidates...")
        
        candidates_count = min(len(docs), RERANK_CANDIDATES)
        pairs = [[question, d.page_content] for d in docs[:candidates_count]]
        
        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: batch_size –¥–ª—è GPU
        scores = self._get_reranker().predict(pairs, batch_size=16)

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ score
        ranked = sorted(
            zip(docs[:candidates_count], scores),
            key=lambda x: x[1],
            reverse=True
        )

        # –ù–û–í–û–ï: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ threshold
        top_docs = [
            doc for doc, score in ranked[:RERANK_TOP_K]
            if score >= RERANK_SCORE_THRESHOLD  # –¢–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ
        ]

        log.info(
            f"Reranking: {len(ranked)} candidates -> {len(top_docs)} "
            f"above threshold ({RERANK_SCORE_THRESHOLD})"
        )

        # –ò–°–ü–†–ê–í–õ–ï–ù–û: Fallback –∫ top-k –±–µ–∑ threshold, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ—à–ª–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
        if not top_docs:
            log.warning(
                f"No documents above threshold for query: {question[:100]}, "
                f"using fallback to top-{RERANK_TOP_K}"
            )
            top_docs = [doc for doc, score in ranked[:RERANK_TOP_K]]

        context = self._build_context(top_docs, query_type, show_full=False)
        return top_docs, context

    # ================= CONTEXT =================

    def _build_context(self, docs: List[Document], query_type: Dict = None, show_full=False) -> str:
        """
        –£–õ–£–ß–®–ï–ù–ù–ê–Ø –≤–µ—Ä—Å–∏—è: –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å —Ç–æ—á–Ω—ã–º –ø–æ–¥—Å—á—ë—Ç–æ–º —Ç–æ–∫–µ–Ω–æ–≤
        
        ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ –æ–±—Ä–µ–∑–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        """
        parts = []
        total_tokens = 0
        truncated = False  # ‚úÖ –ù–û–í–û–ï: –§–ª–∞–≥ –æ–±—Ä–µ–∑–∞–Ω–∏—è

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º
        if query_type:
            is_specific_article = query_type.get("type") == "specific_article"
        else:
            is_specific_article = show_full

        for i, doc in enumerate(docs, 1):
            doc_id = doc.metadata.get("doc_id", "unknown")
            order_index = doc.metadata.get("article_order_index", "unknown")
            reference = doc.metadata.get("reference", "")
            part = doc.metadata.get("part", "?")
            content = doc.page_content
            content_length = len(content)

            # –õ–æ–≥–∏—Ä—É–µ–º doc_id –∏ order_index –¥–ª—è –¥–µ–±–∞–≥–∞
            log.debug(
                f"Processing doc [{i}]: doc_id={doc_id}, order_index={order_index}, "
                f"ref={reference}, len={content_length}"
            )

            # ========== –°–¢–†–ê–¢–ï–ì–ò–Ø 1: –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è - –í–°–ï–ì–î–ê –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç ==========
            if is_specific_article:
                formatted_content = content
                log.debug(f"Specific article mode: full text ({content_length} chars)")

            # ========== –°–¢–†–ê–¢–ï–ì–ò–Ø 2: –ö–æ—Ä–æ—Ç–∫–∞—è —Å—Ç–∞—Ç—å—è - –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç ==========
            elif content_length <= SHORT_ARTICLE_THRESHOLD:
                formatted_content = content
                log.debug(f"Short article: full text ({content_length} chars)")

            # ========== –°–¢–†–ê–¢–ï–ì–ò–Ø 3: –î–ª–∏–Ω–Ω–∞—è —Å—Ç–∞—Ç—å—è –≤ general —Ä–µ–∂–∏–º–µ ==========
            else:
                # –£–º–Ω–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                formatted_content = self._smart_truncate(content, LONG_ARTICLE_SUMMARY_LENGTH)
                log.debug(f"Long article: truncated {content_length} -> {len(formatted_content)} chars")

            # –§–æ—Ä–º–∏—Ä—É–µ–º –±–ª–æ–∫
            block = f"[–ò—Å—Ç–æ—á–Ω–∏–∫ {i}] {reference} (—á–∞—Å—Ç—å {part} –ì–ö –†–§)\n{formatted_content}"

            # ================= –¢–û–ß–ù–´–ô –ü–û–î–°–ß–Å–¢ –¢–û–ö–ï–ù–û–í =================
            block_tokens = len(self.tokenizer.encode(block))

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            if total_tokens + block_tokens > MAX_CONTEXT_TOKENS:
                truncated = True  # ‚úÖ –ù–û–í–û–ï: –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω
                log.warning(
                    f"Context size limit reached: {total_tokens} + {block_tokens} = {total_tokens + block_tokens} > {MAX_CONTEXT_TOKENS}. "
                    f"Truncating at {i} documents (included {len(parts)}/{len(docs)})"
                )
                break

            parts.append(block)
            total_tokens += block_tokens

        separator = "\n\n" + "="*50 + "\n\n"
        final_context = separator.join(parts)

        # ‚úÖ –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω
        if truncated:
            included_articles = []
            for part in parts:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç–∞—Ç–µ–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                match = re.search(r'—Å—Ç\.?\s*(\d+)', part)
                if match:
                    included_articles.append(match.group(1))
            
            truncation_warning = (
                f"\n\n{'='*50}\n"
                f"‚ö†Ô∏è –ö–û–ù–¢–ï–ö–°–¢ –û–ë–†–ï–ó–ê–ù –ü–û –õ–ò–ú–ò–¢–£ –¢–û–ö–ï–ù–û–í\n"
                f"{'='*50}\n\n"
                f"–í–∫–ª—é—á–µ–Ω–æ: {len(parts)} –∏–∑ {len(docs)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n"
                f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {total_tokens} / {MAX_CONTEXT_TOKENS}\n\n"
            )
            
            if included_articles:
                truncation_warning += (
                    f"–í–∫–ª—é—á—ë–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏: {', '.join(set(included_articles))}\n\n"
                )
            
            truncation_warning += (
                f"üí° –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
                f"   /article <–Ω–æ–º–µ—Ä>\n"
                f"   –ù–∞–ø—Ä–∏–º–µ—Ä: /article 454\n"
            )
            
            final_context = truncation_warning + final_context

        log.info(
            f"‚úÖ Context built: {len(docs)} documents, {len(parts)} included, "
            f"{total_tokens} tokens / {MAX_CONTEXT_TOKENS} limit ({total_tokens / MAX_CONTEXT_TOKENS * 100:.1f}%), "
            f"truncated={truncated}"
        )

        return final_context


    def _smart_truncate(self, content: str, max_length: int) -> str:
        """
        –£–º–Ω–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
        1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏
        2. –ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç (–æ–±—ã—á–Ω–æ –≥–ª–∞–≤–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
        3. –ü—É–Ω–∫—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        4. –ó–∞–≤–µ—Ä—à–∞—é—â–∏–µ —É—Å–ª–æ–≤–∏—è
        """
        lines = content.split('\n')

        # –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏
        header = []
        body = []
        for line in lines:
            if line.startswith('–°—Ç–∞—Ç—å—è'):
                header.append(line)
            else:
                body.append(line)

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        result = '\n'.join(header) + '\n\n'

        # –ë–µ—Ä–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–ª–∞ —Å—Ç–∞—Ç—å–∏
        body_text = '\n'.join(body)
        remaining_length = max_length - len(result)

        if len(body_text) <= remaining_length:
            return result + body_text

        # –°–æ–∫—Ä–∞—â–∞–µ–º —Å —É–º–Ω—ã–º –æ–±—Ä–µ–∑–∞–Ω–∏–µ–º –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
        truncated = body_text[:remaining_length]

        # –û–±—Ä–µ–∑–∞–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø–æ–ª–Ω–æ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é
        last_period = max(
            truncated.rfind('.'),
            truncated.rfind('?'),
            truncated.rfind('!')
        )

        if last_period > remaining_length * 0.7:  # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ—Ç–∏
            truncated = truncated[:last_period + 1]

        return result + truncated + "\n\n[... —Å—Ç–∞—Ç—å—è —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã, –Ω–µ –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç]"

    def _get_article_explanation(self, article_ref: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏ –ø–æ —Å—Å—ã–ª–∫–µ
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ—á–Ω—ã—Ö FAQ –æ—Ç–≤–µ—Ç–æ–≤
        """
        # –ü–∞—Ä—Å–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å—Ç. 196 –ì–ö –†–§")
        match = re.search(r'—Å—Ç\.?\s*(\d+)', article_ref.lower())
        if not match:
            return f"üìñ {article_ref}\n\n–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å."

        article_num = match.group(1)
        docs = self.db.get_article_by_number(article_num)

        if not docs:
            return f"üìñ {article_ref}\n\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç —ç—Ç–æ–π —Å—Ç–∞—Ç—å–∏."

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–µ—Ä–µ–¥–∞–µ–º query_type –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏)
        query_type = {"type": "specific_article", "article_num": article_num}
        context = self._build_context(docs, query_type, show_full=True)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ LLM
        user_prompt = (
            f"–î–∞–π –∫—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è {article_ref}.\n\n"
            f"–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏:{context}\n\n"
            "–û–±—ä—è—Å–Ω–∏ –æ—Å–Ω–æ–≤–Ω—É—é —Å—É—Ç—å —Å—Ç–∞—Ç—å–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º."
        )

        messages = [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt}
        ]

        try:
            response = self.llm.invoke(messages)
            answer = response.content.strip()

            # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è FAQ
            validator = AnswerValidator(self.db)
            is_valid, error_msg = validator.validate(article_ref, answer, docs)

            if not is_valid:
                log.warning(f"FAQ answer validation warning: {error_msg}")
                # –î–ª—è FAQ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º, –∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º

            # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Å–∫–ª–µ–π–º–µ—Ä
            answer += (
                "\n\n‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. "
                "–î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            )

            return answer

        except Exception as e:
            log.error(f"Error generating article explanation: {e}", exc_info=True)
            return f"üìñ {article_ref}\n\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è."

    # ================= GENERATION =================

    def generate_answer(self, question: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
        
        Args:
            question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        if not self._is_safe(question):
            log.warning(f"Unsafe query detected: {question[:100]}")
            return "‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
        cached = self.cache.get(question)
        if cached:
            return cached

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º enhanced analyzer)
        query_type = self.enhanced_analyzer.analyze(question)
        log.info(f"Query type: {query_type['type']}, details: {query_type}")

        # –ù–û–í–û–ï: Rule-based routing
        route_type, direct_answer = self.router.route(question, query_type)
        log.info(f"Route: {route_type}")

        if route_type == "exact_faq" and direct_answer:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∏–∑ FAQ (–±–µ–∑ –≤—ã–∑–æ–≤–∞ LLM)
            log.info("Exact FAQ match - returning cached answer")
            answer = direct_answer
            self.cache.set(question, answer)
            return answer

        # –ü–æ–ª—É—á–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
        docs, context = self.retrieve_documents(question, query_type)

        if not docs:
            answer = (
                "‚ùå –ù–µ –Ω–∞—à–µ–ª —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –ì–ö –†–§ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É.\n\n"
                "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                "‚Ä¢ –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å\n"
                "‚Ä¢ –£—Ç–æ—á–Ω–∏—Ç—å –æ–±–ª–∞—Å—Ç—å –ø—Ä–∞–≤–∞\n"
                "‚Ä¢ –£–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: '—á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç —Å—Ç–∞—Ç—å—è 454?')"
            )
            self.cache.set(question, answer)
            return answer

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω—ã –ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤)
        if query_type["type"] == "general":
            clarification = QueryClarifier.needs_clarification(question, docs)
            if clarification:
                self.cache.set(question, clarification)
                return clarification

        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
        if query_type["type"] == "article_range":
            user_prompt = (
                f"–í–æ–ø—Ä–æ—Å: {question}\n\n"
                f"–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç–µ–π –ì–ö –†–§:{context}\n\n"
                "–î–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å—Ç–∞—Ç–µ–π."
            )
        elif query_type["type"] == "specific_article":
            # –ó–∞–ø—Ä–æ—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏ - —Ç—Ä–µ–±—É–µ–º –¥–æ—Å–ª–æ–≤–Ω–æ–µ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            user_prompt = (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é.\n\n"
                f"–í–æ–ø—Ä–æ—Å: {question}\n\n"
                f"–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏:{context}\n\n"
                f"–í–ê–ñ–ù–û: –î–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –î–û–°–õ–û–í–ù–´–ú —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–ª—é—á–µ–≤—ã—Ö –Ω–æ—Ä–º –≤ –∫–∞–≤—ã—á–∫–∞—Ö."
            )
        else:
            # –û–±—â–∏–π –≤–æ–ø—Ä–æ—Å - –±–æ–ª–µ–µ –≥–∏–±–∫–∏–π –ø–æ–¥—Ö–æ–¥
            user_prompt = (
                f"–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}\n\n"
                f"–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –Ω–æ—Ä–º—ã –ì–ö –†–§:{context}\n\n"
                f"–í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–∏ –Ω–æ—Ä–º—ã. –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, "
                f"–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—Å—Ç. X –ø. Y –ì–ö –†–§). "
                f"–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–ø–æ–ª–Ω—ã–π - –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏."
            )

        messages = [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt}
        ]

        try:
            log.info("Generating answer with LLM...")
            response = self.llm.invoke(messages)
            answer = response.content.strip()

            # –ù–û–í–û–ï: –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            validator = AnswerValidator(self.db)
            is_valid, error_msg = validator.validate(question, answer, docs)

            if not is_valid:
                log.error(f"Answer validation failed: {error_msg}")
                return (
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å.\n\n"
                    f"–ü—Ä–∏—á–∏–Ω–∞: {error_msg}\n\n"
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help"
                )

            # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Å–∫–ª–µ–π–º–µ—Ä
            answer += (
                "\n\n‚ö†Ô∏è <i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. "
                "–î–ª—è —Ç–æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</i>"
            )

            # –ö–µ—à–∏—Ä—É–µ–º
            self.cache.set(question, answer)
            
            log.info("Answer generated successfully")
            return answer

        except Exception as e:
            log.error(f"Error generating answer: {e}", exc_info=True)
            return (
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞.\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
            )

    # ================= STATS =================

    def get_cache_stats(self) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–µ—à–∞"""
        return self.cache.stats()

    def get_db_stats(self) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ë–î"""
        return self.db.get_stats()


# ================= SINGLETON =================

_rag_instance = None
_rag_lock = Lock()  # –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è singleton


def get_rag_engine() -> LegalRAG:
    global _rag_instance
    if _rag_instance is not None:
        return _rag_instance
    with _rag_lock:
        if _rag_instance is None:
            _rag_instance = LegalRAG()
    return _rag_instance



# –£–¥–æ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
def generate_answer(question: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å"""
    engine = get_rag_engine()
    return engine.generate_answer(question)


def get_cache_stats() -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–µ—à–∞"""
    engine = get_rag_engine()
    return engine.get_cache_stats()


def get_db_stats() -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ë–î"""
    engine = get_rag_engine()
    return engine.get_db_stats()
