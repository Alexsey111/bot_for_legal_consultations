"""
ingest_data.py
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–≥–æ –∫–æ–¥–µ–∫—Å–∞ –†–§ –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
"""
from pathlib import Path
from dotenv import load_dotenv
import structlog

from database import LegalVectorDB

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –î–û –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
load_dotenv() 

log = structlog.get_logger()


def main():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ì–ö –†–§ –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –±–∞–∑—É"""
    
    print()
    print("=" * 70)
    print("üöÄ –ó–ê–ì–†–£–ó–ö–ê –ì–†–ê–ñ–î–ê–ù–°–ö–û–ì–û –ö–û–î–ï–ö–°–ê –†–§ –í –í–ï–ö–¢–û–†–ù–£–Æ –ë–î")
    print("=" * 70)
    print()
    
    # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
    gk_file = Path("knowledge_base/gk_rf.txt")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
    if not gk_file.exists():
        print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {gk_file}")
        print()
        print("üìù –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:")
        print("1. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É: knowledge_base/")
        print("2. –°–∫–∞—á–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ì–ö –†–§ (–≤—Å–µ 4 —á–∞—Å—Ç–∏)")
        print("3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫: knowledge_base/gk_rf.txt")
        print()
        print("üì• –ì–¥–µ —Å–∫–∞—á–∞—Ç—å:")
        print("‚Ä¢ http://www.consultant.ru/document/cons_doc_LAW_5142/")
        print("‚Ä¢ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Å–µ —á–∞—Å—Ç–∏ (1-4) –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª")
        print()
        print("üìã –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:")
        print("–ì–ª–∞–≤–∞ 1. –ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã")
        print("–°—Ç–∞—Ç—å—è 1. –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏")
        print("1. –¢–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ –ø—É–Ω–∫—Ç–∞...")
        print("2. –¢–µ–∫—Å—Ç –≤—Ç–æ—Ä–æ–≥–æ –ø—É–Ω–∫—Ç–∞...")
        print()
        print("–°—Ç–∞—Ç—å—è 2. –°–ª–µ–¥—É—é—â–∞—è —Å—Ç–∞—Ç—å—è...")
        print()
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    file_size = gk_file.stat().st_size
    file_size_mb = file_size / (1024 * 1024)
    
    print(f"‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω: {gk_file}")
    print(f"üìä –†–∞–∑–º–µ—Ä: {file_size_mb:.2f} MB ({file_size:,} –±–∞–π—Ç)")
    print()
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π
    if file_size_mb < 1.0:
        print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –§–∞–π–ª –∫–∞–∂–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–º!")
        print("   –ü–æ–ª–Ω—ã–π –ì–ö –†–§ (–≤—Å–µ 4 —á–∞—Å—Ç–∏) –æ–±—ã—á–Ω–æ –æ–∫–æ–ª–æ 2-4 MB")
        print("   –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ –Ω–µ –≤–µ—Å—å —Ç–µ–∫—Å—Ç?")
        print()
        response = input("‚ùì –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É? (yes/no): ")
        if response.lower() not in ['yes', 'y', '–¥–∞', '–¥']:
            print("‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞")
            return
        print()
    
    print("‚è≥ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    print("   –≠—Ç–æ –∑–∞–π–º–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 5-10 –º–∏–Ω—É—Ç (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)")
    print()
    print("üí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:")
    print("   ‚Ä¢ Embeddings (text-embedding-3-small): ~$0.02")
    print("   ‚Ä¢ –†–∞–∑–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è")
    print()
    
    try:
        # –°–æ–∑–¥–∞–µ–º –ë–î –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º
        db = LegalVectorDB()
        db.rebuild_from_file(str(gk_file))
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = db.get_stats()
        
        print()
        print("=" * 70)
        print("‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!")
        print("=" * 70)
        print()
        print("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"   ‚Ä¢ –í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {stats['total_chunks']}")
        print(f"   ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π: {stats['unique_articles']}")
        print(f"   ‚Ä¢ –ü—É–Ω–∫—Ç–æ–≤ —Å—Ç–∞—Ç–µ–π: {stats['point_chunks']}")
        print(f"   ‚Ä¢ –¶–µ–ª—ã—Ö —Å—Ç–∞—Ç–µ–π: {stats['full_article_chunks']}")
        print()
        print("üéâ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!")
        print()
        print("‚ñ∂Ô∏è  –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:")
        print("   python main.py")
        print()
        
    except FileNotFoundError as e:
        print()
        print("=" * 70)
        print("‚ùå –û–®–ò–ë–ö–ê: –§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù")
        print("=" * 70)
        print(f"   {e}")
        print()
        
    except ValueError as e:
        print()
        print("=" * 70)
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–ï–í–ï–†–ù–´–ô –§–û–†–ú–ê–¢ –î–ê–ù–ù–´–•")
        print("=" * 70)
        print(f"   {e}")
        print()
        print("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("   ‚Ä¢ –§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ç–µ–π –≤ –æ–∂–∏–¥–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ")
        print("   ‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ '–°—Ç–∞—Ç—å—è N.'")
        print("   ‚Ä¢ –§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–π")
        print()
        
    except Exception as e:
        print()
        print("=" * 70)
        print("‚ùå –û–®–ò–ë–ö–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï")
        print("=" * 70)
        log.error("ingest_error", error_type=type(e).__name__, error=str(e)[:200])
        print()
        print("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("   1. –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ OpenAI API")
        print("   2. –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á –≤ .env —Ñ–∞–π–ª–µ")
        print("   3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ OpenAI")
        print("   4. –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É")
        print()
        print("üîß –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:")
        print("   ‚Ä¢ –§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç OPENAI_API_KEY")
        print("   ‚Ä¢ API –∫–ª—é—á –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω")
        print("   ‚Ä¢ –ù–∞ –∞–∫–∫–∞—É–Ω—Ç–µ OpenAI –µ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞")
        print("   ‚Ä¢ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ")
        print()


if __name__ == "__main__":
    main()
